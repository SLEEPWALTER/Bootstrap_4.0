<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

<!-- TOP NAVBAR -->
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-text text-white">
            <b th:text="${currentUser.username}"></b>
            <span>with roles:</span>
            <span th:each="r : ${currentUser.authorities}" th:text="${r.authority} + ' '"></span>
        </span>

        <form th:action="@{/logout}" method="post" class="d-inline">
            <button class="btn btn-outline-light btn-sm">Logout</button>
        </form>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">

        <!-- SIDEBAR -->
        <div class="col-2 px-0 bg-light border-end" style="height: 100vh;">
            <ul class="nav flex-column nav-pills mt-3">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" th:href="@{/admin}">Admin</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user}">User</a>
                </li>
            </ul>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-10 px-4">
            <h2 class="mt-3 mb-3">Admin panel</h2>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Users table</h5>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        New User
                    </button>
                </div>

                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Age</th>
                            <th>Email</th>
                            <th>Roles</th>
                            <th>Actions</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:each="user : ${users}">
                            <td th:text="${user.id}"></td>
                            <td th:text="${user.username}"></td>
                            <td th:text="${user.age}"></td>
                            <td th:text="${user.email}"></td>

                            <td>
                                <span th:each="role, stat : ${user.roles}"
                                      th:text="${role.name} + (${stat.last} ? '' : ', ')">
                                </span>
                            </td>

                            <td>
                                <button type="button" class="btn btn-warning btn-sm edit-btn"
                                        th:attr="data-id=${user.id}">
                                    Edit
                                </button>
                                <a th:href="@{/delete(id=${user.id})}"
                                   class="btn btn-danger btn-sm"
                                   onclick="return confirm('Delete user?')">
                                    Delete
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal для добавления нового пользователя -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add new user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/save}" method="post" th:object="${newUser}" id="addUserForm" onsubmit="return validateRoles('addUserForm')">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" th:field="*{username}" required>
                    </div>
                    <div class="mb-3">
                        <label for="age" class="form-label">Age</label>
                        <input type="number" class="form-control" id="age" th:field="*{age}" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" th:field="*{email}" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" th:field="*{password}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <div th:each="role : ${allRoles}">
                            <div class="form-check">
                                <input class="form-check-input role-checkbox" type="checkbox" th:value="${role.id}"
                                       th:id="'role_' + ${role.id}" name="roleIds">
                                <label class="form-check-label" th:for="'role_' + ${role.id}"
                                       th:text="${role.name}"></label>
                            </div>
                        </div>
                        <div class="text-danger" id="roleError" style="display: none;">Please select at least one role</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add new user</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal для редактирования пользователя -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/save}" method="post" id="editUserForm" onsubmit="return validateRoles('editUserForm')">
                <div class="modal-body">
                    <input type="hidden" id="editUserId" name="id">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAge" class="form-label">Age</label>
                        <input type="number" class="form-control" id="editAge" name="age" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">Password (leave empty to keep current)</label>
                        <input type="password" class="form-control" id="editPassword" name="password" placeholder="Leave empty to keep current password">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <div th:each="role : ${allRoles}">
                            <div class="form-check">
                                <input class="form-check-input role-checkbox" type="checkbox" th:value="${role.id}"
                                       th:id="'editRole_' + ${role.id}" name="roleIds">
                                <label class="form-check-label" th:for="'editRole_' + ${role.id}"
                                       th:text="${role.name}"></label>
                            </div>
                        </div>
                        <div class="text-danger" id="editRoleError" style="display: none;">Please select at least one role</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Edit</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Обработчик для кнопок редактирования
    document.addEventListener('DOMContentLoaded', function() {
        const editButtons = document.querySelectorAll('.edit-btn');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                // Находим строку таблицы
                const row = this.closest('tr');
                const username = row.cells[1].textContent;
                const age = row.cells[2].textContent;
                const email = row.cells[3].textContent;

                // Получаем роли из текста
                const rolesText = row.cells[4].textContent;
                const roleNames = rolesText.split(',').map(role => role.trim());

                openEditModal(id, username, age, email, roleNames);
            });
        });

        // Валидация ролей
        const roleCheckboxes = document.querySelectorAll('.role-checkbox');
        roleCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const form = this.closest('form');
                const roleError = form.id === 'addUserForm' ? document.getElementById('roleError') : document.getElementById('editRoleError');
                roleError.style.display = 'none';
            });
        });

        // Очистка формы добавления при закрытии модального окна
        const addUserModal = document.getElementById('addUserModal');
        addUserModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('addUserForm').reset();
            document.getElementById('roleError').style.display = 'none';
        });

        // Очистка формы редактирования при закрытии модального окна
        const editUserModal = document.getElementById('editUserModal');
        editUserModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('editUserForm').reset();
            document.getElementById('editRoleError').style.display = 'none';
        });
    });

    function openEditModal(id, username, age, email, roleNames) {
        // Заполняем форму редактирования данными пользователя
        document.getElementById('editUserId').value = id;
        document.getElementById('editUsername').value = username;
        document.getElementById('editAge').value = age;
        document.getElementById('editEmail').value = email;

        // Очищаем чекбоксы ролей
        const roleCheckboxes = document.querySelectorAll('#editUserForm input[type="checkbox"]');
        roleCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        // Устанавливаем выбранные роли пользователя на основе названий ролей
        roleCheckboxes.forEach(checkbox => {
            const roleLabel = checkbox.nextElementSibling.textContent.trim();
            if (roleNames.includes(roleLabel)) {
                checkbox.checked = true;
            }
        });

        // Скрываем ошибку ролей
        document.getElementById('editRoleError').style.display = 'none';

        // Показываем модальное окно
        const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
        editModal.show();
    }

    function validateRoles(formId) {
        const form = document.getElementById(formId);
        const roleCheckboxes = form.querySelectorAll('.role-checkbox');
        const roleError = formId === 'addUserForm' ? document.getElementById('roleError') : document.getElementById('editRoleError');

        let atLeastOneChecked = false;
        roleCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                atLeastOneChecked = true;
            }
        });

        if (!atLeastOneChecked) {
            roleError.style.display = 'block';
            return false;
        } else {
            roleError.style.display = 'none';
            return true;
        }
    }
</script>

</body>
</html>